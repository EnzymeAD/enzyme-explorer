version: "3.4"
services:
  compiler-explorer:
    image: ghcr.io/enzymead/enzyme-explorer:latest
    ports:
      - "80:10240"
    volumes:
      - type: bind
        source: /home/ubuntu/compiler-explorer/etc/config
        target: /app/compiler-explorer/etc/config
        read_only: true
      - type: bind
        source: /home/ubuntu/compiler-explorer/lib/shortener
        target: /app/compiler-explorer/lib/shortener
        read_only: true
      - type: bind
        source: /home/ubuntu/compiler-explorer/views/_layout.pug
        target: /app/compiler-explorer/views/_layout.pug
        read_only: true
      - type: bind
        source: /home/ubuntu/compiler-explorer/examples
        target: /app/compiler-explorer/examples
        read_only: true
      - type: bind
        source: /home/ubuntu/compiler-explorer/views/resources/site-logo.svg
        target: /app/compiler-explorer/views/resources/site-logo.svg
        read_only: true
      - type: bind
        source: /opt/compiler-explorer
        target: /opt/compiler-explorer
        read_only: true
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
       test: ["CMD", "curl", "-f", "http://localhost:10240/explorer"]
       interval: 30s
       timeout: 10s
       retries: 3
       start_period: 210s

# compiler-builder:
#   image: ubuntu:20.04
#   volumes:
#     - type: bind
#       source: /home/ubuntu/compiler-explorer/etc/config
#       target: /app/compiler-explorer/etc/config
#     - type: bind
#       source: /opt/compiler-explorer
#       target: /opt/compiler-explorer
  
